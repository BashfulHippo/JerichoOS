name: x86-64 build and test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: install rust nightly
      uses: dtolnay/rust-toolchain@nightly
      with:
        toolchain: nightly-2026-02-01
        components: rust-src, llvm-tools-preview

    - name: install qemu
      run: sudo apt-get update && sudo apt-get install -y qemu-system-x86

    - name: build kernel
      run: |
        # first pass compiles the kernel binary + bootloader stages
        cargo build --bin jericho_os --release --features bootloader-build
        # build.rs runs before the kernel is linked, so boot images
        # aren't created on a clean build. force a rerun now that
        # the kernel binary exists
        touch build.rs
        cargo build --bin jericho_os --release --features bootloader-build

    - name: check binary size
      run: |
        BOOT_IMAGE=$(find target -name "boot-bios.img" 2>/dev/null | head -1)
        if [ -z "$BOOT_IMAGE" ]; then
          echo "boot image not found, listing build artifacts for debug:"
          find target -name "*.img" -o -name "*.efi" 2>/dev/null || true
          exit 1
        fi

        echo "found: $BOOT_IMAGE"
        SIZE=$(stat -c%s "$BOOT_IMAGE")
        SIZE_KB=$((SIZE / 1024))
        echo "boot image: ${SIZE_KB}kb"

        if [ $SIZE -gt 10485760 ]; then
          echo "too big (> 10mb)"
          exit 1
        fi

    - name: run demos
      timeout-minutes: 1
      run: |
        chmod +x demo_x86.sh
        ./demo_x86.sh > output.txt 2>&1
        cat output.txt

    - name: validate results
      run: |
        for i in 1 2 3 4 5; do
          if ! grep -q "DEMO_RESULT:$i:PASS" output.txt; then
            echo "demo $i failed"
            cat output.txt
            exit 1
          fi
          echo "demo $i passed"
        done

        if grep -q "DEMO_RESULT:[1-5]:FAIL" output.txt; then
          echo "one or more demos reported failure"
          cat output.txt
          exit 1
        fi

        if ! grep -q "Suite: All demos completed successfully" output.txt; then
          echo "demo suite did not complete cleanly"
          cat output.txt
          exit 1
        fi

        echo "all demos passed"

    - name: save artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: x86-64-output
        path: |
          output.txt
          target/**/out/boot-*.img
        retention-days: 7
